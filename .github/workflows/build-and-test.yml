name: Build and Test IP Template

# This workflow provides a comprehensive build and test pipeline for Vyges IP projects
# This template workflow runs automatically on push/PR and can be manually triggered
# Focus is on simulation, synthesis, and verification with open-source tools

# Configuration variables - modify these to change versions
# These are used throughout the workflow for version consistency

on:
  # Manual trigger only - template repository
  workflow_dispatch:
    inputs:
      design_type:
        description: 'Design type and tool requirements'
        required: false
        default: 'digital'
        type: choice
        options:
          - digital       # Digital only (Verilator, Yosys, FPGA tools)
          - analog        # Analog only (Xschem, Magic, ngspice)
          - mixed         # Mixed-signal (Digital + Analog tools)
          - chiplets      # Chiplet integration (Advanced packaging)
          - tapeout       # Full tapeout flow (Efabless-style)
      test_simulation:
        description: 'Run simulation tests'
        required: false
        default: true
        type: boolean
      test_synthesis:
        description: 'Run synthesis tests'
        required: false
        default: true
        type: boolean
      test_linting:
        description: 'Run linting checks'
        required: false
        default: true
        type: boolean
      test_validation:
        description: 'Run validation checks'
        required: false
        default: true
        type: boolean

# Manual trigger only - this template workflow can be manually triggered
# for testing different design types and configurations

jobs:
  # Main build and test job - everything runs sequentially on one runner
  build-and-test:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      pages: write
      id-token: write
    env:
      # Configuration variables - modify these to change versions
      
      # Infrastructure
      UBUNTU_VERSION: "24.04"          # Ubuntu runner version (e.g., "24.04", "22.04")
      
      # Python Environment
      PYTHON_VERSION: "3.12"           # Python version (e.g., "3.10", "3.11", "3.12")
      PYTHON_VERSION_SHORT: "3.12"     # Python version for commands (e.g., "3.10", "3.11", "3.12")
      
      # Simulation Tools
      VERILATOR_VERSION: "5.038"       # Verilator version (e.g., "5.038", "5.039")
      ICARUS_VERSION: "14.0"           # Icarus Verilog version (e.g., "14.0", "13.0")
      GHDL_VERSION: "latest"           # GHDL version (e.g., "latest", "4.0")
      GTKWAVE_VERSION: "latest"        # GTKWave version (e.g., "latest", "3.3")
      SURFER_VERSION: "latest"         # Surfer web-based VCD viewer (e.g., "latest", "1.0")
      PANDOC_VERSION: "latest"         # Pandoc markdown converter (e.g., "latest", "3.0")
      
      # Synthesis Tools
      YOSYS_VERSION: "latest"          # Yosys version (e.g., "latest", "0.34")
      ABC_VERSION: "latest"            # Berkeley ABC version (e.g., "latest", "1.01")
      
      # Layout & Verification Tools
      MAGIC_VERSION: "latest"          # Magic version (e.g., "latest", "8.3")
      NETGEN_VERSION: "latest"         # Netgen version (e.g., "latest", "1.5")
      KLAYOUT_VERSION: "latest"        # KLayout version (e.g., "latest", "0.28")
      
      # FPGA Tools
      NEXTPNR_VERSION: "latest"        # NextPNR version (e.g., "latest", "0.6")
      SYMBIFLOW_VERSION: "latest"      # SymbiFlow version (e.g., "latest", "2023.12")
      VPR_VERSION: "latest"            # VPR version (e.g., "latest", "8.0")
      OPENFPGA_VERSION: "latest"       # OpenFPGA version (e.g., "latest", "1.0")
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup workflow for testing
        run: |
          echo "ðŸ”§ Setting up workflow for testing..."
          echo "Design Type: ${{ github.event.inputs.design_type || 'digital' }}"
          echo "âœ… Workflow runs automatically on push/PR"
          echo "This will install all tools to verify the build process"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install core system packages
        run: |
          # Update package list
          sudo apt-get update
          
          # Install core packages (always needed)
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            git \
            wget \
            curl \
            tree \
            unzip \
            make \
            python3 \
            python3-pip \
            python3-venv \
            bison \
            flex \
            help2man \
            libfl-dev \
            libfl2 \
            libgit2-dev \
            libgoogle-perftools-dev \
            libz-dev \
            perl \
            ruby \
            ruby-dev \
            time \
            zlib1g \
            zlib1g-dev \
            gettext \
            gnat

      - name: Install digital tools (digital, mixed, chiplets, tapeout)
        if: contains('${{ github.event.inputs.design_type }}', 'digital') || contains('${{ github.event.inputs.design_type }}', 'mixed') || contains('${{ github.event.inputs.design_type }}', 'chiplets') || contains('${{ github.event.inputs.design_type }}', 'tapeout')
        run: |
          echo "ðŸ”§ Installing digital design tools..."
          
          # Install digital simulation and synthesis tools
          sudo apt-get install -y --no-install-recommends \
            libqt5multimediawidgets5 \
            libqt5opengl5 \
            libqt5svg5-dev \
            libqt5xmlpatterns5-dev \
            qtmultimedia5-dev \
            qttools5-dev

      - name: Install analog tools (analog, mixed, tapeout)
        if: contains('${{ github.event.inputs.design_type }}', 'analog') || contains('${{ github.event.inputs.design_type }}', 'mixed') || contains('${{ github.event.inputs.design_type }}', 'tapeout')
        run: |
          echo "ðŸ”§ Installing analog design tools..."
          
          # Install analog design tools
          sudo apt-get install -y --no-install-recommends \
            magic \
            netgen \
            xschem \
            ngspice

      - name: Install KLayout (digital, mixed, chiplets, tapeout)
        if: contains('${{ github.event.inputs.design_type }}', 'digital') || contains('${{ github.event.inputs.design_type }}', 'mixed') || contains('${{ github.event.inputs.design_type }}', 'chiplets') || contains('${{ github.event.inputs.design_type }}', 'tapeout')
        run: |
          echo "ðŸ”§ Installing KLayout for layout viewing..."
          sudo apt-get install -y klayout
          klayout -v

      - name: Install Yosys (digital, mixed, chiplets, tapeout)
        if: contains('${{ github.event.inputs.design_type }}', 'digital') || contains('${{ github.event.inputs.design_type }}', 'mixed') || contains('${{ github.event.inputs.design_type }}', 'chiplets') || contains('${{ github.event.inputs.design_type }}', 'tapeout')
        run: |
          echo "ðŸ”§ Installing Yosys for digital synthesis..."
          
          # Install Yosys from Ubuntu repositories
          sudo apt-get install -y yosys
          
          # Verify installation
          yosys -V
          
          # Check if slang module is available
          if yosys -m slang -p "slang_version" 2>/dev/null; then
            echo "âœ… Yosys with slang support installed"
          else
            echo "âš ï¸  Yosys installed but slang module not available"
          fi
          
          # Get Yosys version
          YOSYS_VERSION=$(yosys -V | grep -oP 'Yosys \K[0-9]+\.[0-9]+' || echo "unknown")
          echo "Installed Yosys version: $YOSYS_VERSION"
          
          # Note: Ubuntu 24.04 Yosys version may be older than 0.39
          # This is acceptable for template testing
          echo "âœ… Yosys installation completed"

      - name: Install Verilator (digital, mixed, chiplets, tapeout)
        if: contains('${{ github.event.inputs.design_type }}', 'digital') || contains('${{ github.event.inputs.design_type }}', 'mixed') || contains('${{ github.event.inputs.design_type }}', 'chiplets') || contains('${{ github.event.inputs.design_type }}', 'tapeout')
        run: |
          echo "ðŸ”§ Installing Verilator from Ubuntu package..."
          sudo apt-get install -y verilator
          verilator --version

      - name: Install OpenROAD tools (chiplets, tapeout) - DISABLED
        if: false  # Disabled due to long installation time
        run: |
          echo "ðŸ”§ Installing OpenROAD tools for advanced ASIC flows..."
          
          # Clone OpenROAD-flow-scripts repository
          git clone https://github.com/The-OpenROAD-Project/OpenROAD-flow-scripts.git
          cd OpenROAD-flow-scripts
          
          # Build OpenROAD tools (this includes TritonFPlan, RePlAce, TritonCTS, FastRoute, TritonRoute)
          ./build_openroad.sh
          
          # Add OpenROAD tools to PATH
          echo 'export PATH=$PATH:'$(pwd)'/tools/OpenROAD/build/src' >> $GITHUB_ENV
          echo 'export PATH=$PATH:'$(pwd)'/tools/RePlAce/build/RePlAce' >> $GITHUB_ENV
          echo 'export PATH=$PATH:'$(pwd)'/tools/FastRoute/build/FastRoute' >> $GITHUB_ENV
          
          # Verify installations
          echo "âœ… OpenROAD tools installed"
          echo "Note: These tools are now available for advanced ASIC design flows"

      - name: Install GHDL Yosys plugin (digital, mixed, chiplets, tapeout) - DISABLED
        if: false  # Disabled due to Ubuntu 24.04 Yosys version incompatibility
        run: |
          echo "âš ï¸ GHDL Yosys plugin installation disabled"
          echo "Reason: Ubuntu 24.04 Yosys version (0.33) is too old for GHDL plugin"
          echo "Note: VHDL synthesis support not available in this template"
          echo "For VHDL support, use a newer Yosys version or install manually"

      - name: Install Open PDKs (analog, mixed, tapeout) - DISABLED
        if: false  # Disabled due to long installation time
        run: |
          echo "ðŸ”§ Installing Open PDKs for analog design..."
          
          # Clone Open PDKs repository
          git clone https://github.com/RTimothyEdwards/open_pdks.git
          cd open_pdks
          
          # Install Open PDKs (includes sky130, gf180mcu, etc.)
          ./configure --enable-sky130-pdk --enable-gf180mcu-pdk
          make
          sudo make install
          
          # Set PDK_ROOT environment variable
          echo 'export PDK_ROOT=/usr/local/share/pdk' >> $GITHUB_ENV
          
          # Verify installation
          echo "âœ… Open PDKs installed"
          echo "Available PDKs: sky130, gf180mcu"
          echo "PDK_ROOT set to: /usr/local/share/pdk"

      - name: Install Icarus Verilog (digital, mixed, chiplets, tapeout)
        if: contains('${{ github.event.inputs.design_type }}', 'digital') || contains('${{ github.event.inputs.design_type }}', 'mixed') || contains('${{ github.event.inputs.design_type }}', 'chiplets') || contains('${{ github.event.inputs.design_type }}', 'tapeout')
        run: |
          echo "ðŸ”§ Installing Icarus Verilog for digital simulation..."
          sudo apt-get install -y iverilog
          iverilog -V

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install cocotb pytest pytest-cov

      - name: Setup Vyges CLI (if available)
        run: |
          # Check if Vyges CLI is available
          if command -v vyges &> /dev/null; then
            echo "Vyges CLI found"
            vyges --version
          else
            echo "Vyges CLI not found - skipping CLI-based tests"
          fi

      - name: Detect and verify installed tools
        run: |
          echo "ðŸ” Detecting and verifying installed tools..."
          echo "================================================"
          
          # Python and Python tools
          if command -v python${{ env.PYTHON_VERSION_SHORT }} &> /dev/null; then
            echo "âœ… Python ${{ env.PYTHON_VERSION_SHORT }}: $(python${{ env.PYTHON_VERSION_SHORT }} --version)"
          elif command -v python3 &> /dev/null; then
            echo "âœ… Python3: $(python3 --version)"
          elif command -v python &> /dev/null; then
            echo "âœ… Python: $(python --version)"
          else
            echo "âŒ Python not found"
          fi
          
          # Check cocotb installation
          if command -v cocotb-config &> /dev/null; then
            echo "âœ… cocotb-config: $(which cocotb-config)"
            echo "âœ… cocotb: $(python3 -c 'import cocotb; print(cocotb.__version__)' 2>/dev/null || echo 'cocotb available')"
          else
            echo "âš ï¸ cocotb-config not found in PATH"
            # Check common installation locations
            COCOTB_PATHS=("$HOME/.local/bin/cocotb-config" "/usr/local/bin/cocotb-config" "/usr/bin/cocotb-config")
            COCOTB_FOUND=false
            for path in "${COCOTB_PATHS[@]}"; do
              if [ -f "$path" ]; then
                echo "âœ… cocotb-config found at: $path"
                COCOTB_FOUND=true
                break
              fi
            done
            if [ "$COCOTB_FOUND" = false ]; then
              echo "âŒ cocotb-config not found in any expected location"
            fi
          fi
          
          # Simulation tools
          if command -v verilator &> /dev/null; then
            echo "âœ… Verilator: $(verilator --version | head -1)"
          else
            echo "âŒ Verilator not found"
          fi
          
          if command -v iverilog &> /dev/null; then
            echo "âœ… Icarus Verilog: $(iverilog -V | head -1)"
          else
            echo "âŒ Icarus Verilog not found"
          fi
          
          if command -v ghdl &> /dev/null; then
            echo "âœ… GHDL: $(ghdl --version 2>/dev/null | head -1 || echo 'GHDL available')"
          else
            echo "âš ï¸ GHDL not found (optional for VHDL simulation)"
          fi
          
          # Synthesis tools
          if command -v yosys &> /dev/null; then
            echo "âœ… Yosys: $(yosys -V | head -1)"
          else
            echo "âŒ Yosys not found"
          fi
          
          if command -v abc &> /dev/null; then
            echo "âœ… Berkeley ABC: $(abc -v 2>/dev/null | head -1 || echo 'ABC available')"
          else
            echo "â„¹ï¸ Berkeley ABC not found (optional for synthesis)"
          fi
          
          # Layout & Verification tools
          if command -v magic &> /dev/null; then
            echo "âœ… Magic: $(magic --version 2>/dev/null | head -1 || echo 'Magic available')"
          else
            echo "âš ï¸ Magic not found (optional for layout)"
          fi
          
          if command -v netgen &> /dev/null; then
            echo "âœ… Netgen: $(netgen -version 2>/dev/null | head -1 || echo 'Netgen available')"
          else
            echo "âš ï¸ Netgen not found (optional for LVS)"
          fi
          
          if command -v klayout &> /dev/null; then
            echo "âœ… KLayout: $(klayout -v 2>/dev/null | head -1 || echo 'KLayout available')"
          else
            echo "âš ï¸ KLayout not found (optional for layout viewing)"
          fi
          
          # FPGA tools
          if command -v nextpnr-ice40 &> /dev/null; then
            echo "âœ… NextPNR ICE40: $(nextpnr-ice40 --version 2>/dev/null | head -1 || echo 'NextPNR ICE40 available')"
          else
            echo "âš ï¸ NextPNR ICE40 not found (optional for FPGA P&R)"
          fi
          
          if command -v nextpnr-ecp5 &> /dev/null; then
            echo "âœ… NextPNR ECP5: $(nextpnr-ecp5 --version 2>/dev/null | head -1 || echo 'NextPNR ECP5 available')"
          else
            echo "âš ï¸ NextPNR ECP5 not found (optional for FPGA P&R)"
          fi
          
          # Utility tools
          if command -v gtkwave &> /dev/null; then
            echo "âœ… GTKWave: $(gtkwave --version 2>/dev/null | head -1 || echo 'GTKWave available')"
          else
            echo "âš ï¸ GTKWave not found (optional for waveform viewing)"
          fi
          
          if command -v pandoc &> /dev/null; then
            echo "âœ… Pandoc: $(pandoc --version 2>/dev/null | head -1 || echo 'Pandoc available')"
          else
            echo "âš ï¸ Pandoc not found (optional for documentation generation)"
          fi
          
          # Vyges CLI
          if command -v vyges &> /dev/null; then
            echo "âœ… Vyges CLI: $(vyges --version 2>/dev/null || echo 'Vyges CLI available')"
          else
            echo "â„¹ï¸ Vyges CLI not found (optional for metadata validation)"
          fi
          
          echo "================================================"
          echo "âœ… Tool detection complete"

      - name: Validate project structure
        if: ${{ github.event.inputs.test_validation == 'true' }}
        run: |
          echo "ðŸ” Validating project structure..."
          
          # Check for required directories
          required_dirs=("rtl" "tb" "docs" "test")
          for dir in "${required_dirs[@]}"; do
            if [ -d "$dir" ]; then
              echo "âœ… Found $dir/"
            else
              echo "âš ï¸ Missing $dir/ (optional for template)"
            fi
          done
          
          # Check for required files
          required_files=("README.md" "LICENSE" "NOTICE")
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… Found $file"
            else
              echo "âŒ Missing $file"
              exit 1
            fi
          done
          
          # Check for metadata template
          if [ -f "vyges-metadata.template.json" ]; then
            echo "âœ… Found vyges-metadata.template.json"
          else
            echo "âš ï¸ Missing vyges-metadata.template.json"
          fi
          
          echo "âœ… Project structure validation complete"

      - name: Validate metadata (if Vyges CLI available)
        if: ${{ github.event.inputs.test_validation == 'true' }}
        run: |
          if command -v vyges &> /dev/null; then
            echo "ðŸ” Validating metadata with Vyges CLI..."
            vyges validate --dry-run || echo "âš ï¸ Metadata validation failed (expected for template)"
          else
            echo "â­ï¸ Skipping metadata validation (Vyges CLI not available)"
          fi

      - name: Run linting checks
        if: ${{ github.event.inputs.test_linting == 'true' }}
        run: |
          echo "ðŸ” Linting SystemVerilog files..."
          
          # Find all .sv files
          sv_files=$(find . -name "*.sv" -type f)
          
          if [ -z "$sv_files" ]; then
            echo "â„¹ï¸ No SystemVerilog files found (expected for template)"
          else
            for file in $sv_files; do
              echo "Linting $file..."
              verilator --lint-only --Wall --Wno-fatal "$file" || echo "âš ï¸ Lint issues in $file"
            done
          fi
          
          echo "âœ… Linting complete"

      - name: Check file permissions
        if: ${{ github.event.inputs.test_linting == 'true' }}
        run: |
          echo "ðŸ” Checking file permissions..."
          
          # Check for executable scripts
          scripts=$(find . -name "*.sh" -type f)
          for script in $scripts; do
            if [ ! -x "$script" ]; then
              echo "âš ï¸ Script $script is not executable"
            fi
          done
          
          echo "âœ… File permission check complete"

      - name: Run simulation tests
        if: ${{ github.event.inputs.test_simulation == 'true' }}
        run: |
          echo "ðŸ§ª Running simulation tests..."
          
          # Check for testbench files
          if [ -d "tb" ]; then
            echo "Found testbench directory"
            
            # Look for SystemVerilog testbenches
            sv_tb_files=$(find tb -name "tb_*.sv" -type f)
            if [ -n "$sv_tb_files" ]; then
              echo "Found SystemVerilog testbenches: $sv_tb_files"
              # Note: Actual test execution would require specific testbench setup
              echo "â„¹ï¸ SystemVerilog testbench execution requires specific setup"
            fi
            
            # Look for cocotb testbenches
            cocotb_files=$(find tb -name "test_*.py" -type f)
            if [ -n "$cocotb_files" ]; then
              echo "Found cocotb testbenches: $cocotb_files"
            else
              echo "â„¹ï¸ No cocotb testbenches found (expected for template)"
            fi
            
            if [ -z "$sv_tb_files" ] && [ -z "$cocotb_files" ]; then
              echo "â„¹ï¸ No testbench files found (expected for template)"
            fi
          else
            echo "â„¹ï¸ No testbench directory found (expected for template)"
          fi
          
          echo "âœ… Simulation test check complete"

      - name: Run Cocotb testbench tests
        if: ${{ github.event.inputs.test_simulation == 'true' }}
        run: |
          echo "ðŸ§ª Running Cocotb testbench tests..."
          if [ -d "tb/cocotb" ] && [ -f "tb/cocotb/Makefile" ]; then
            cd tb/cocotb
            
            # Check if cocotb-config is available
            if command -v cocotb-config >/dev/null 2>&1; then
              echo "âœ… cocotb-config found: $(which cocotb-config)"
              echo "Running Cocotb tests with Icarus..."
              make SIM=icarus || echo "âš ï¸ Cocotb Icarus tests failed"
              echo "Running Cocotb tests with Verilator..."
              make SIM=verilator || echo "âš ï¸ Cocotb Verilator tests failed"
            else
              echo "âš ï¸ cocotb-config not found, checking for fallback..."
              # Check if cocotb-config is in common locations
              COCOTB_CONFIG_PATHS=("$HOME/.local/bin/cocotb-config" "/usr/local/bin/cocotb-config" "/usr/bin/cocotb-config")
              COCOTB_FOUND=false
              
              for path in "${COCOTB_CONFIG_PATHS[@]}"; do
                if [ -f "$path" ]; then
                  echo "âœ… Found cocotb-config at: $path"
                  export PATH="$(dirname "$path"):$PATH"
                  COCOTB_FOUND=true
                  break
                fi
              done
              
              if [ "$COCOTB_FOUND" = true ]; then
                echo "Running Cocotb tests with Icarus (using found cocotb-config)..."
                make SIM=icarus || echo "âš ï¸ Cocotb Icarus tests failed"
                echo "Running Cocotb tests with Verilator (using found cocotb-config)..."
                make SIM=verilator || echo "âš ï¸ Cocotb Verilator tests failed"
              else
                echo "âŒ cocotb-config not found in any expected location"
                echo "Skipping Cocotb tests - cocotb not properly installed"
              fi
            fi
            
            cd ../..
          else
            echo "No Cocotb Makefile found in tb/cocotb/"
          fi
          echo "âœ… Cocotb testbench tests complete"

      - name: Check synthesis configuration
        if: ${{ github.event.inputs.test_synthesis == 'true' }}
        run: |
          echo "ðŸ”§ Checking synthesis configuration..."
          
          # Check ASIC configuration
          if [ -d "flow/openlane" ]; then
            echo "âœ… Found OpenLane configuration for ASIC"
            if [ -f "flow/openlane/config.json" ]; then
              echo "âœ… Found OpenLane config.json"
            fi
          else
            echo "â„¹ï¸ No OpenLane configuration found (expected for template)"
          fi
          
          # Check FPGA configuration
          if [ -d "flow/vivado" ]; then
            echo "âœ… Found Vivado configuration for FPGA"
          else
            echo "â„¹ï¸ No Vivado configuration found (expected for template)"
          fi
          
          echo "âœ… Synthesis configuration check complete"

      - name: Generate test report
        run: |
          echo "ðŸ“Š Test Report"
          echo "=============="
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Design Type: ${{ github.event.inputs.design_type }}"
          echo ""
          echo "Tool Installation:"
          echo "- Core Tools: âœ… Always installed"
          if [[ "${{ github.event.inputs.design_type }}" =~ ^(digital|mixed|chiplets|tapeout)$ ]]; then
            echo "- Digital Tools: âœ… Installed (Verilator, Yosys, Icarus, GHDL)"
          else
            echo "- Digital Tools: â­ï¸ Skipped"
          fi
          if [[ "${{ github.event.inputs.design_type }}" =~ ^(analog|mixed|tapeout)$ ]]; then
            echo "- Analog Tools: âœ… Installed (Magic, Xschem, ngspice, Open PDKs)"
          else
            echo "- Analog Tools: â­ï¸ Skipped"
          fi
          if [[ "${{ github.event.inputs.design_type }}" =~ ^(chiplets|tapeout)$ ]]; then
            echo "- Advanced Tools: âœ… Installed (OpenROAD, TritonRoute)"
          else
            echo "- Advanced Tools: â­ï¸ Skipped"
          fi
          echo ""
          echo "Test Results:"
          echo "- Validation: ${{ github.event.inputs.test_validation == 'true' && 'âœ… ENABLED' || 'â­ï¸ DISABLED' }}"
          echo "- Linting: ${{ github.event.inputs.test_linting == 'true' && 'âœ… ENABLED' || 'â­ï¸ DISABLED' }}"
          echo "- Simulation: ${{ github.event.inputs.test_simulation == 'true' && 'âœ… ENABLED' || 'â­ï¸ DISABLED' }}"
          echo "- Synthesis: ${{ github.event.inputs.test_synthesis == 'true' && 'âœ… ENABLED' || 'â­ï¸ DISABLED' }}"
          echo ""
          echo "Note: This is a template repository. Actual tests require IP-specific implementation."

      - name: Generate comprehensive reports
        run: |
          echo "ðŸ“Š Generating comprehensive reports..."
          
          # Create public directory for reports
          mkdir -p public
          
          # Generate test harness report
          if [ -f "scripts/generate_test_harness_report.py" ]; then
            echo "ðŸ”§ Generating test harness report..."
            python3 scripts/generate_test_harness_report.py
            if [ -f "test_harness_report.md" ]; then
              cp test_harness_report.md public/
              echo "âœ… Test harness report generated and copied to public directory"
            fi
          fi
          
          # Generate code KPIs report
          if [ -f "scripts/code_kpis.py" ]; then
            echo "ðŸ”§ Generating code KPIs report..."
            python3 scripts/code_kpis.py --output json > public/code_kpis.json 2>/dev/null || echo "Code KPIs report generation failed"
            python3 scripts/code_kpis.py > public/code_kpis.txt 2>/dev/null || echo "Code KPIs text report generation failed"
            echo "âœ… Code KPIs reports generated"
          fi
          
          # Create CSS for HTML reports
          cat > public/report-style.css << 'EOF'
          <style>
          body { 
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
              max-width: 1200px; 
              margin: 0 auto; 
              padding: 20px; 
              line-height: 1.6;
              color: #24292e;
          }
          .vyges-footer {
              background: #f8f9fa;
              border-top: 1px solid #e1e4e8;
              padding: 20px 0;
              margin: 40px -20px -20px -20px;
              text-align: center;
              color: #586069;
          }
          .vyges-footer p {
              margin: 5px 0;
          }
          .vyges-footer strong {
              color: #0366d6;
          }
          h1 { 
              color: #0366d6; 
              border-bottom: 2px solid #e1e4e8; 
              padding-bottom: 10px; 
              margin-top: 0;
          }
          h2 { 
              color: #24292e; 
              margin-top: 30px; 
              border-bottom: 1px solid #e1e4e8;
              padding-bottom: 5px;
          }
          h3 { 
              color: #24292e; 
              margin-top: 25px; 
          }
          table { 
              border-collapse: collapse; 
              width: 100%; 
              margin: 20px 0;
          }
          th, td { 
              border: 1px solid #e1e4e8; 
              padding: 12px; 
              text-align: left; 
          }
          th { 
              background-color: #f6f8fa; 
              font-weight: 600;
          }
          tr:nth-child(even) { 
              background-color: #f6f8fa; 
          }
          code { 
              background-color: #f6f8fa; 
              padding: 2px 4px; 
              border-radius: 3px; 
              font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
          }
          pre { 
              background-color: #f6f8fa; 
              padding: 16px; 
              border-radius: 6px; 
              overflow-x: auto;
          }
          .highlight { 
              background-color: #fff3cd; 
              padding: 10px; 
              border-radius: 4px; 
              border-left: 4px solid #ffc107;
          }
          .success { 
              background-color: #d4edda; 
              padding: 10px; 
              border-radius: 4px; 
              border-left: 4px solid #28a745;
          }
          .error { 
              background-color: #f8d7da; 
              padding: 10px; 
              border-radius: 4px; 
              border-left: 4px solid #dc3545;
          }
          </style>
          EOF
          
          # Create Vyges footer
          cat > public/vyges-footer.html << 'EOF'
          <div class="vyges-footer">
              <p><strong>Vyges Platform</strong> - Build Silicon Like Software</p>
              <p>Generated by Vyges IP Template - Comprehensive EDA Toolchain</p>
              <p>Open-source tools for digital, analog, and mixed-signal design</p>
          </div>
          EOF
          
          # Convert test harness report to HTML
          if [ -f "public/test_harness_report.md" ]; then
            if command -v pandoc &> /dev/null; then
              pandoc public/test_harness_report.md -o public/test_harness_report.html --css=public/report-style.css --standalone --metadata title="Vyges IP Template - Test Harness Report" --include-after-body=public/vyges-footer.html
              echo "âœ… Converted test harness report to HTML with pandoc"
            else
              echo "âš ï¸ Pandoc not found, creating basic HTML report..."
              cat > public/test_harness_report.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Vyges IP Template - Test Harness Report</title>
              <link rel="stylesheet" href="report-style.css">
          </head>
          <body>
              <h1>Vyges IP Template - Test Harness Report</h1>
              <p><em>Generated: $(date -u)</em></p>
              <div class="highlight">
                  <p><strong>Note:</strong> This is a basic HTML report generated without pandoc. For full formatting, install pandoc.</p>
              </div>
              <pre><code>$(cat public/test_harness_report.md)</code></pre>
          </body>
          </html>
          EOF
              echo "âœ… Created basic HTML report (pandoc not available)"
            fi
          fi
          
          echo "âœ… Comprehensive report generation complete"

      - name: Create GitHub Pages index
        run: |
          echo "ðŸŒ Creating GitHub Pages index..."
          
          # Create index.html for GitHub Pages
          cat > public/index.html << EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Vyges IP Template - Reports</title>
              <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@1,400&display=swap" rel="stylesheet">
              <style>
                  body { 
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
                      max-width: 1200px; 
                      margin: 0 auto; 
                      padding: 20px; 
                      line-height: 1.6;
                      color: #24292e;
                  }
                  h1 { 
                      color: #0366d6; 
                      border-bottom: 2px solid #e1e4e8; 
                      padding-bottom: 10px; 
                      margin-top: 0;
                  }
                  h2 { 
                      color: #24292e; 
                      margin-top: 30px; 
                      border-bottom: 1px solid #e1e4e8;
                      padding-bottom: 5px;
                  }
                  .timestamp { 
                      color: #586069; 
                      font-size: 14px; 
                      margin-bottom: 30px;
                  }
                  table { 
                      border-collapse: collapse; 
                      width: 100%; 
                      margin: 20px 0;
                      background: white;
                      border-radius: 8px;
                      overflow: hidden;
                      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                  }
                  th, td { 
                      border: 1px solid #e1e4e8; 
                      padding: 16px; 
                      text-align: left; 
                      vertical-align: top;
                  }
                  th { 
                      background-color: #f6f8fa; 
                      font-weight: 600;
                      color: #24292e;
                  }
                  tr:nth-child(even) { 
                      background-color: #f8f9fa; 
                  }
                  tr:hover { 
                      background-color: #f1f3f4; 
                  }
                  .report-link { 
                      display: inline-block; 
                      background: #0366d6; 
                      color: white; 
                      padding: 6px 12px; 
                      text-decoration: none; 
                      border-radius: 4px; 
                      margin: 2px 4px 2px 0;
                      font-size: 12px;
                      font-weight: 500;
                  }
                  .report-link:hover { 
                      background: #0256cc; 
                      text-decoration: none;
                  }
                  .report-link.html { 
                      background: #28a745; 
                  }
                  .report-link.html:hover { 
                      background: #218838; 
                  }
                  .report-link.md { 
                      background: #6c757d; 
                  }
                  .report-link.md:hover { 
                      background: #5a6268; 
                  }
                  .status-badge {
                      display: inline-block;
                      padding: 4px 8px;
                      border-radius: 12px;
                      font-size: 12px;
                      font-weight: 500;
                      text-transform: uppercase;
                  }
                  .status-success {
                      background: #d4edda;
                      color: #155724;
                  }
                  .status-warning {
                      background: #fff3cd;
                      color: #856404;
                  }
                  .status-info {
                      background: #d1ecf1;
                      color: #0c5460;
                  }
              </style>
          </head>
          <body>
              <h1>Vyges IP Template - Reports</h1>
              <div class="timestamp">
                  Generated: $(date -u)<br>
                  Repository: ${{ github.repository }}<br>
                  Workflow: ${{ github.workflow }}<br>
                  Run ID: ${{ github.run_id }}
              </div>
              
              <div class="highlight">
                  <p><strong>Template Repository:</strong> This is the Vyges IP Template repository. Use "Use this template" to create your own IP project with this comprehensive EDA toolchain.</p>
              </div>
              
              <h2>Available Reports</h2>
              <table>
                  <thead>
                      <tr>
                          <th>Report Type</th>
                          <th>Description</th>
                          <th>Status</th>
                          <th>Links</th>
                      </tr>
                  </thead>
                  <tbody>
                      <tr>
                          <td><strong>Test Harness Report</strong></td>
                          <td>Comprehensive test results and simulation analysis</td>
                          <td><span class="status-badge status-success">Available</span></td>
                          <td>
                              <a href="./test_harness_report.html" class="report-link html">HTML</a>
                              <a href="./test_harness_report.md" class="report-link md">Markdown</a>
                          </td>
                      </tr>
                      <tr>
                          <td><strong>Code KPIs Report</strong></td>
                          <td>Code quality metrics and project analysis</td>
                          <td><span class="status-badge status-success">Available</span></td>
                          <td>
                              <a href="./code_kpis.txt" class="report-link md">Text</a>
                              <a href="./code_kpis.json" class="report-link md">JSON</a>
                          </td>
                      </tr>
                      <tr>
                          <td><strong>Workflow Status</strong></td>
                          <td>Current workflow execution status and tool installation</td>
                          <td><span class="status-badge status-info">Template</span></td>
                          <td>
                              <span class="report-link md">Template Only</span>
                          </td>
                      </tr>
                  </tbody>
              </table>
              
              <h2>Template Information</h2>
              <div class="success">
                  <p><strong>Design Type Support:</strong> digital, analog, mixed, chiplets, tapeout</p>
                  <p><strong>Toolchain:</strong> Verilator, Yosys, Icarus, Magic, ngspice, OpenROAD, and more</p>
                  <p><strong>Testbench Support:</strong> SystemVerilog, Cocotb, UVM</p>
                  <p><strong>FPGA Support:</strong> Open-source FPGA tools (Yosys, NextPNR)</p>
              </div>
              
              <div class="vyges-footer">
                  <p><strong>Vyges Platform</strong> - Build Silicon Like Software</p>
                  <p>Generated by Vyges IP Template - Comprehensive EDA Toolchain</p>
                  <p>Open-source tools for digital, analog, and mixed-signal design</p>
              </div>
          </body>
          </html>
          EOF
          
          echo "âœ… GitHub Pages index created"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vyges-ip-template-build-artifacts
          path: |
            test_harness_report.md
            scripts/
            flow/*/reports/
            flow/*/build/
            tb/*/build/
            tb/*/waves/
            tb/*/coverage/
            tb/*/*.vcd
            tb/*/obj_dir/*.vcd
          retention-days: 30

      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ðŸš€ Deploying template reports to GitHub Pages..."
          
          # Configure git for deployment with proper authentication
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create a clean working directory for deployment
          echo "Setting up clean deployment environment..."
          
          # Check if gh-pages branch exists
          if git ls-remote --heads origin gh-pages | grep gh-pages; then
            echo "gh-pages branch exists, creating clean checkout..."
            # Create a temporary directory for deployment
            mkdir -p /tmp/gh-pages-deploy
            cd /tmp/gh-pages-deploy
            
            # Clone the gh-pages branch (shallow clone for speed)
            git clone --branch gh-pages --single-branch --depth=1 https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git .
            
            # Remove all existing files
            git rm -rf . || true
            
            # Copy new files from the original workspace
            cp -r ${{ github.workspace }}/public/* .
            
            # Commit and push
            git add .
            git commit -m "Update template reports - $(date -u)" || echo "No changes to commit"
            git push origin gh-pages
            
            echo "âœ… GitHub Pages deployment complete!"
          else
            echo "gh-pages branch not found, creating new one..."
            # Create a temporary directory for deployment
            mkdir -p /tmp/gh-pages-deploy
            cd /tmp/gh-pages-deploy
            
            # Initialize new repository
            git init
            git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            
            # Copy files from the original workspace
            cp -r ${{ github.workspace }}/public/* .
            
            # Create and push gh-pages branch
            git add .
            git commit -m "Initial template reports - $(date -u)"
            git branch -M gh-pages
            git push -u origin gh-pages
            
            echo "âœ… GitHub Pages deployment complete!"
          fi
          
          echo "ðŸ“– Template reports available at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

      - name: Workflow status
        run: |
          echo "ðŸŽ‰ Template workflow completed successfully!"
          echo "This template repository is ready for IP development."
          echo ""
          echo "Next steps:"
          echo "1. Use 'Use this template' to create a new repository"
          echo "2. Clone your new repository"
          echo "3. Run 'vyges init --interactive' to set up your IP"
          echo "4. Add your RTL and testbenches"
          echo "5. Enable this workflow in your new repository" 

 